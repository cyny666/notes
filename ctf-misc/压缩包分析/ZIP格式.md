ZIP文件主要由三部分构成，分别为

| 压缩源文件数据区                               | 核心目录          | 目录结束                        |
| ---------------------------------------------- | ----------------- | ------------------------------- |
| local file header + file data +data descriptor | central directory | end of central directory record |

* 压缩源文件数据区中每一个压缩的源文件或目录都是一条记录，其中
  * local file header：文件头用于标识该文件的开始，记录了该压缩文件的信息，这里的文件头标识由固定值50 4B 03 04 开头，也是ZIP的文件头的重要标志
  * file data：文件数据记录了相应压缩文件的数据
  * data descriptor：数据描述符用于标识该文件压缩结束，该结构只有在相应的local file header中通用标记字段的第3bit设为1时才会出现，紧接在压缩文件源数据后
* Central directory核心目录
* End of central directory record（EOCD）目录结束标识
* 目录结束标识存在于整个归档包的结尾，用于标记压缩的目录数据的结束。每个压缩文件必须有且只有一个EOCD记录

### CRC32

CRC本身是冗余校验码的意思，CRC32则表示会产生一个32bit（8位十六进制数）的校验值。由于CRC32产生校验值时元数据的每一个bit(位)都参与了计算，所以数据块中即使只有一位发生了变化，也会得到不同的CRC32值。

CRC32校验码出现在很多文件中比如png文件，同样zip中也有CRC32校验码。值得注意的是zip中CRC32是未加密文件的校验值。

这也就导致了基于CRC32的攻击手法

* 文件内内容很少（一般比赛中大多为4字节左右）
* 加密的密码很长

我们不去爆破压缩包的密码，而是直接去爆破源文件的内容（一般都是可见的字符串），从而获取想要的信息。

### 明文攻击

* 一个加密的压缩文件
* 压缩文件的压缩工具，比如2345好压，WinRAR，7z。zip版本号等，可以通过文件属性了解。如果是linux平台，用zipinfo-v可以查看一个zip包的详细信息，包括加密算法等
* 知道压缩包里某个文件的部分连续内容（至少12字节）

### 伪加密

在上文ZIP格式的核心目录区中，我们强调了一个叫做通用位标记（General purpose bit flag）的2字节，不同比特位有着不同的含义

```
Bit:0 IF set, indicates that the file is encrypted
```

修改伪加密的方法：

* 16进制下修改通用位标记
* binwalk -e 无视伪加密
* 在Mac OS及部分Linux（如kali）系统中，可以直接打开伪加密的ZIP压缩包
* 检测伪加密的小工具ZipCen0p.jar
* 有时候用WinRAR的修复功能

